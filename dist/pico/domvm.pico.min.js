// https://github.com/domvm/domvm (3.x-dev, pico build)
!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n(e.domvm={})}(this,function(e){"use strict";var C=1,a=2,R=3,S=4,E=5,t="undefined"!=typeof window?document:{},f={};function V(){}var d=Array.isArray;function o(e){return null!=e&&e.constructor===Object}function r(e,n,t,l){e.splice.apply(e,[t,l].concat(n))}function u(e){var n=typeof e;return"string"===n||"number"===n}function s(e){return"function"==typeof e}function i(e){return"object"==typeof e&&s(e.then)}function n(e){for(var n=arguments,t=1;t<n.length;t++)for(var l in n[t])e[l]=n[t][l];return e}function l(e,n,t){var l;while(l=n.shift())0===n.length?e[l]=t:e[l]=e=e[l]||{}}function c(e,n,t){return function(){return e.apply(t,n)}}function v(e){for(var n,t,l,r=e.slice(),i=[0],o=0,u=0;u<e.length;++u){var a=e[u];if(-1!==a)if(e[l=i[o]]<a)r[u]=l,i[++o]=u;else{n=0,t=o;while(n<t)e[i[l=(n+t)/2|0]]<a?n=l+1:t=l;a<e[i[n]]&&(0<n&&(r[u]=i[n-1]),i[n]=u)}}t=i[o];while(0<=o)t=r[i[o--]=t];return i}function y(e,n){var t,l=0,r=n.length-1;if(r<=2147483647)while(l<=r){if(n[t=l+r>>1]===e)return t;n[t]<e?l=t+1:r=t-1}else while(l<=r){if(n[t=Math.floor((l+r)/2)]===e)return t;n[t]<e?l=t+1:r=t-1}return l==n.length?null:l}function p(e){return"o"===e[0]&&"n"===e[1]}function h(e){return"style"===e}function b(e){e&&e.el&&e.el.offsetHeight}function j(e){return null!=e.node&&null!=e.node.el}function m(e,n){switch(n){case"value":case"checked":case"selected":return true}return false}function w(e){e=e||f;while(null==e.vm&&e.parent)e=e.parent;return e.vm}function g(){}function k(e){var n=new g;return n.type=a,n.body=e,n}n(g.prototype={constructor:g,type:null,vm:null,key:null,ref:null,data:null,hooks:null,ns:null,el:null,tag:null,attrs:null,body:null,flags:0,_diff:null,_dead:false,_lis:false,idx:null,parent:null},{a:function(e){return this.attrs=e,this},b:function(e){return this.body=e,this},k:function(e){return this.key=e,this},r:function(e){return this.ref=e,this},h:function(e){return this.hooks=e,this},f:function(e){return this.flags=e,this},d:function(e){return this.data=e,this}});var _=1,A=2,M=4,U=8;function x(e,n,t,l){var r=new g;return r.type=C,r.flags=l||0,r.attrs=n||null,r.tag=e,null!=t&&(r.body=t)instanceof N&&(r.flags=t.flags),r}function N(t,l,n){var r,i=this,o=t.length;i.flags=U,i.items=t,i.length=o,i.key=function(){return null},i.diff={val:function(e,n){return l.val(t[e],n)},cmp:function(e,n){return l.cmp(n._diff,i.diff.val(e))}},i.tpl=function(e){return r(t[e],e)},i.map=function(e){return r=e,i},i.body=function(e){for(var n=[],t=0;t<o;t++){var l=i.tpl(t);l.type!=S&&(l._diff=i.diff.val(t,e)),n.push(l)}e.body=n,T(e)},null!=n&&(i.flags|=M,i.key=function(e){return n(t[e],e)})}function D(e,n,t){l(e,("refs."+n).split("."),t)}function I(e){while(e=e.parent)e.flags|=_}function L(e,n,t,l){if(e.type!==E&&e.type!==S){e.parent=n,e.idx=t,e.vm=l,null!=e.ref&&D(w(e),e.ref,e);var r=e.hooks,i=l&&l.hooks;(r&&(r.willRemove||r.didRemove)||i&&(i.willUnmount||i.didUnmount))&&I(e),d(e.body)?T(e):""===e.body?e.body=null:null==e.body||e.body instanceof N||(e.body=""+e.body)}}function T(e){for(var n=e.body,t=0;t<n.length;t++){var l=n[t];false===l||null==l?n.splice(t--,1):d(l)?r(n,l,t--,1):(null==l.type&&(n[t]=l=k(""+l)),l.type===a?null==l.body||""===l.body?n.splice(t--,1):0<t&&n[t-1].type===a?(n[t-1].body+=l.body,n.splice(t--,1)):L(l,e,t,null):L(l,e,t,null))}}function O(e,n){return n}function B(e,n){var t=(e.attrs||f).style,l=n?(n.attrs||f).style:null;if(null==t||u(t))e.el.style.cssText=t;else{for(var r in t){var i=t[r];(null==l||null!=i&&i!==l[r])&&(e.el.style[r]=O(0,i))}if(l)for(var o in l)null==t[o]&&(e.el.style[o]="")}}var P={};function Y(e){P[e]||(P[e]=true,H(t,e,q,true))}function F(e,n,t,l){e.removeEventListener(n.slice(2),t,l)}function H(e,n,t,l){e.addEventListener(n.slice(2),t,l)}function K(e,n,t,l,r){if(false===e.apply(r,n.concat([t,l,r,r.data]))||false)return t.preventDefault(),t.stopPropagation(),false}function X(e,n){var t,l,r="on"+e,i=[];while(n)(l=n.attrs)&&(t=l[r])&&d(t)&&i.unshift(t),n=n.parent;return i}function q(e){var n=e.target._node;if(null!=n)for(var t=X(e.type,n),l=w(n),r=0;r<t.length;r++){if(false===K(t[r][0],t[r].slice(1),e,n,l))break}}function z(e,n,t,l){if(t!=l){var r=e.el;s(t)?H(r,n,t,false):null!=t&&Y(n),s(l)&&F(r,n,l,false)}}function G(e,n,t){t?e.el[n]="":e.el.removeAttribute(n)}function J(e,n,t,l){var r=e.el;null!=e.ns?r.setAttribute(n,t):"class"===n?r.className=t:"id"===n||"boolean"==typeof t||l?r[n]=t:"."===n[0]?r[n.substr(1)]=t:r.setAttribute(n,t)}function Q(e,n){var t=e.attrs||f,l=n.attrs||f;if(t===l);else{for(var r in t){var i=t[r];if(null!=i){var o=m(e.tag,r),u=o?e.el[r]:l[r];i===u||(h(r)?B(e,n):p(r)?z(e,r,i,u):J(e,r,i,o))}}for(var r in l)null==t[r]&&(p(r)?z(e,r,t[r],l[r]):G(e,r,m(e.tag,r)))}}function W(e,n,t,l){return e.type===S&&(n=e.data,t=e.key,l=e.opts,e=e.view),new Ve(e,n,t,l)}var Z=[];function $(e,n,t,l,r){if(null!=e){var i=t.hooks[n];if(i){if("d"!==n[0]||"i"!==n[1]||"d"!==n[2])return i(t,l);r?b(t.parent)&&i(t,l):Z.push([i,t,l])}}}function ee(e){if(Z.length){var n;b(e.node);while(n=Z.shift())n[0](n[1],n[2])}}function ne(e,n){return null!=n?t.createElementNS(n,e):t.createElement(e)}function te(e){return t.createTextNode(e)}function le(e){return t.createComment(e)}function re(e){return e.nextSibling}function ie(e){var n=e.vm,t=null!=n&&$(n.hooks,"willUnmount",n,n.data),l=$(e.hooks,"willRemove",e);if((e.flags&_)===_&&d(e.body))for(var r=0;r<e.body.length;r++)ie(e.body[r]);return t||l}function oe(e,n){if(n){var t=e.vm;null!=t&&(t.node=t.refs=null)}var l=e.body;if(d(l))for(var r=0;r<l.length;r++)oe(l[r],true)}function ue(e,n,t){var l=n._node,r=l.vm;if(oe(l,true),(l.flags&_)===_)for(var i=0;i<l.body.length;i++)ue(n,l.body[i].el);delete n._node,e.removeChild(n),$(l.hooks,"didRemove",l,null,t),null!=r&&($(r.hooks,"didUnmount",r,r.data,t),r.node=null)}function ae(e,n){var t=n._node;if(!t._dead){var l=ie(t);null!=l&&i(l)?(t._dead=true,l.then(c(ue,[e,n,true]))):ue(e,n)}}function fe(e){var n=e.el;if(0==(e.flags&_))oe(e,false),n.textContent=null;else{var t=n.firstChild;if(null!=t)do{var l=re(t);ae(n,t)}while(t=l)}}function de(e,n,t){var l=n._node,r=null!=n.parentNode,i=n!==t&&r?null:l.vm;null!=i&&$(i.hooks,"willMount",i,i.data),$(l.hooks,r?"willReinsert":"willInsert",l),e.insertBefore(n,t),$(l.hooks,r?"didReinsert":"didInsert",l),null!=i&&$(i.hooks,"didMount",i,i.data)}function se(e,n,t){de(e,n,t?re(t):null)}function ce(e){for(var n=0;n<e.body.length;n++){var t=e.body[n],l=t.type;if(l<=R)de(e.el,ve(t));else if(l===S){l=(r=W(t.view,t.data,t.key,t.opts)._redraw(e,n,false)).node.type,de(e.el,ve(r.node))}else if(l===E){var r;(r=t.vm)._update(t.data,e,n),l=r.node.type,de(e.el,r.node.el)}}}function ve(e,n){return null==e.el&&(e.type===C?(e.el=n||ne(e.tag,e.ns),null!=e.attrs&&Q(e,f),(e.flags&U)===U&&e.body.body(e),d(e.body)?ce(e):null!=e.body&&(e.el.textContent=e.body)):e.type===a?e.el=n||te(e.body):e.type===R&&(e.el=n||le(e.body))),(e.el._node=e).el}function ye(e){return e.parent}var pe=1,he=2;function be(a,f,d,s,c,v,y,p){return function(e,n,t,l,r,i){var o,u;if(null!=l[s]&&ye(o=l[s]._node)!==e)return u=a(l[s]),null!=o.vm?o.vm.unmount(true):ae(n,l[s]),void(l[s]=u);if(l[c]==r)return he;if(null==l[c].el)d(n,ve(l[c]),l[s]),l[c]=f(l[c],t);else if(l[c].el===l[s])l[c]=f(l[c],t),l[s]=a(l[s]);else{if(i||o!==l[y])return i&&null!=l[s]?me(a,f,d,s,c,n,t,o,l):pe;u=l[s],l[s]=a(u),p(n,u,l[v]),l[v]=u}}}function me(e,n,t,l,r,i,o,u,a){if(u._lis)t(i,a[r].el,a[l]),a[r]=n(a[r],o);else{var f=y(u.idx,a.tombs);u._lis=true;var d=e(a[l]);t(i,a[l],null!=f?o[a.tombs[f]].el:f),null==f?a.tombs.push(u.idx):a.tombs.splice(f,0,u.idx),a[l]=d}}var we=be(re,function(e,n){return n[e.idx+1]},de,"lftSib","lftNode","rgtSib","rgtNode",se),ge=be(function(e){return e.previousSibling},function(e,n){return n[e.idx-1]},se,"rgtSib","rgtNode","lftSib","lftNode",de);function ke(e,n){var t=n.body,l=e.el,r=e.body,i={lftNode:r[0],rgtNode:r[r.length-1],lftSib:(t[0]||f).el,rgtSib:(t[t.length-1]||f).el};e:while(1){while(1){var o=we(e,l,r,i,null,false);if(o===pe)break;if(o===he)break e}while(1){var u=ge(e,l,r,i,i.lftNode,false);if(u===pe)break;if(u===he)break e}_e(e,l,r,i);break}}function _e(e,n,t,l){var r=[],i=n.firstChild;do{var o=i._node;o.parent===e&&r.push(o.idx)}while(i=re(i));for(var u=v(r).map(function(e){return r[e]}),a=0;a<u.length;a++)t[u[a]]._lis=true;l.tombs=u;while(1){if(we(e,n,t,l,null,true)===he)break}}function xe(e){return e.el._node.parent!==e.parent}function Ne(e,n,t){return n[t]}function Ce(e,n,t){for(;t<n.length;t++){var l=n[t];if(null!=l.vm){if(e.type===S&&l.vm.view===e.view&&l.vm.key===e.key||e.type===E&&l.vm===e.vm)return l}else if(!xe(l)&&e.tag===l.tag&&e.type===l.type&&e.key===l.key&&(e.flags&~_)==(l.flags&~_))return l}return null}function Re(e,n,t){if(null==n._keys){if(n[t].key===e.key)return n[t];for(var l={},r=0;r<n.length;r++)l[n[r].key]=r;n._keys=l}return n[n._keys[e.key]]}function Se(e,n){$(n.hooks,"willRecycle",n,e);var t=e.el=n.el,l=n.body,r=e.body;if((t._node=e).type!==a||r===l){null==e.attrs&&null==n.attrs||Q(e,n);var i=d(l),o=d(r),u=(e.flags&U)===U;i?o||u?Ee(e,n):r!==l&&(null!=r?t.textContent=r:fe(n)):o?(fe(n),ce(e)):r!==l&&(null!=r&&null!=l?t.firstChild.nodeValue=r:t.textContent=r),$(n.hooks,"didRecycle",n,e)}else t.nodeValue=r}function Ee(e,n){var t=e.body,l=t.length,r=n.body,i=r.length,o=(e.flags&U)===U,u=(e.flags&A)===A,a=(e.flags&M)===M,f=!u&&e.type===C,d=true,s=0===i?V:a?Re:u||o?Ne:Ce;if(f&&0===l)return fe(n),void(o&&(e.body=[]));var c,v,y=0,p=false,h=0;if(o)var b={key:null},m=e.body=Array(l);for(var w=0;w<l;w++){if(o){var g=false;d&&(a&&(b.key=t.key(w)),c=s(b,r,h)),null!=c?(v=c.idx,t.diff.cmp(w,c)?g=true:((k=c).parent=e,k.idx=w,k._lis=false)):g=true,g&&((k=t.tpl(w)).type===S?k=null!=c?c.vm._update(k.data,e,w).node:W(k.view,k.data,k.key,k.opts)._redraw(e,w,false).node:(L(k,e,w),k._diff=t.diff.val(w,e),null!=c&&Se(k,c))),m[w]=k}else{var k,_=(k=t[w]).type;if(_<=R)(c=d&&s(k,r,h))&&(Se(k,c),v=c.idx);else if(_===S)(c=d&&s(k,r,h))?(v=c.idx,c.vm._update(k.data,e,w)):W(k.view,k.data,k.key,k.opts)._redraw(e,w,false);else if(_===E){var x=k.vm,N=j(x);N&&x.node.parent!=n&&(x.unmount(true),N=false),x._update(k.data,e,w,N)}}if(null!=c&&(v===h?++h===i&&i<l&&(c=null,d=false):p=true,!a&&100<i&&p&&++y%10==0))while(h<i&&xe(r[h]))h++}f&&ke(e,n)}function Ve(e,n,t,l){var r=this;r.view=e,r.data=n,r.key=t,l&&(r.opts=l,r.config(l));var i=o(e)?e:e.call(r,r,n,t,l);s(i)?r.render=i:(r.render=i.render,r.config(i)),r.init&&r.init.call(r,r,r.data,r.key,l)}Ve.prototype={constructor:Ve,init:null,view:null,key:null,data:null,state:null,api:null,opts:null,node:null,hooks:null,refs:null,render:null,mount:function(e,n){var t=this;n?(fe({el:e,flags:0}),t._redraw(null,null,false),e.nodeName.toLowerCase()!==t.node.tag?(ve(t.node),de(e.parentNode,t.node.el,e),e.parentNode.removeChild(e)):de(e.parentNode,ve(t.node,e),e)):(t._redraw(null,null),e&&de(e,t.node.el));e&&ee(t);return t},unmount:function(e){var n=this.node;ae(n.el.parentNode,n.el),n.el=null,e||ee(this)},config:function(e){e.init&&(this.init=e.init),e.diff&&(this.diff=e.diff),e.hooks&&(this.hooks=n(this.hooks||{},e.hooks))},parent:function(){return w(this.node.parent)},root:function(){var e=this.node;while(e.parent)e=e.parent;return e.vm},redraw:function(){return this._redraw(null,null,j(this)),this},update:function(e){return this._update(e,null,null,j(this)),this},_update:function(e,n,t,l){var r=this;null!=e&&r.data!==e&&($(r.hooks,"willUpdate",r,e),r.data=e);return r._redraw(n,t,l)},_redraw:function(e,n,t){var l,r,i=null==e,o=this,u=o.node&&o.node.el&&o.node.el.parentNode,a=null!=o.diff,f=o.node;if(a&&(r=o.diff.val(o,o.data,o.key,e,n),null!=f&&(l=f._diff,!o.diff.cmp(o,l,r))))return je(o,f,e,n);u&&$(o.hooks,"willRedraw",o,o.data);var d=o.render.call(o,o,o.data,o.key,e,n);a&&(d._diff=r);if(d===f)return je(o,f,e,n);(o.refs=null)!=o.key&&d.key!==o.key&&(d.key=o.key);o.node=d,e?(L(d,e,n,o),e.body[n]=d):f&&f.parent?(L(d,f.parent,f.idx,o),f.parent.body[f.idx]=d):L(d,null,null,o);if(false!==t)if(f)if(f.tag!==d.tag||f.key!==d.key){f.vm=d.vm=null;var s=f.el.parentNode,c=re(f.el);ae(s,f.el),de(s,ve(d),c),f.el=d.el,d.vm=o}else Se(d,f);else ve(d);u&&$(o.hooks,"didRedraw",o,o.data),i&&u&&ee(o);return o}};function je(e,n,t,l){return null!=t&&((t.body[l]=n).idx=l,n.parent=t,n._lis=false),e}function Ae(e,n,t,l){var r,i;return null==t?o(n)?r=n:i=n:(r=n,i=t),x(e,r,i,l)}function Me(e,n,t,l){this.view=e,this.data=n,this.key=t,this.opts=l}function Ue(e,n){this.vm=e,this.data=n}Me.prototype={constructor:Me,type:S,view:null,data:null,key:null,opts:null},Ue.prototype={constructor:Ue,type:E,vm:null,data:null},e.ViewModel=Ve,e.VNode=g,e.createView=W,e.defineElement=Ae,e.defineSvgElement=function(e,n,t,l){var r=Ae(e,n,t,l);return r.ns="http://www.w3.org/2000/svg",r},e.defineText=k,e.defineComment=function(e){var n=new g;return n.type=R,n.body=e,n},e.defineView=function(e,n,t,l){return new Me(e,n,t,l)},e.injectView=function(e,n){return new Ue(e,n)},e.injectElement=function(e){var n=new g;return n.type=C,n.el=n.key=e,n},e.list=function(e,n,t){return new N(e,n,t)},e.FIXED_BODY=A,e.KEYED_LIST=M,e.config=function(e){null!=e.syncRedraw&&e.syncRedraw},Object.defineProperty(e,"__esModule",{value:true})});